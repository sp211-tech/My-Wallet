<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Wallet - Expense Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google API & Identity Services -->
    <script async defer src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
    <script async defer src="https://accounts.google.com/gsi/client" onload="gisLoaded()"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa; /* Lighter gray background */
        }
        .dashboard-card {
            transition: transform 0.2s, box-shadow 0.2s;
            border: 1px solid #e9ecef;
        }
        .dashboard-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.07), 0 4px 6px -2px rgba(0,0,0,0.05);
        }
        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: transform 0.2s ease-out, background-color 0.2s;
            z-index: 40;
        }
        .fab:hover {
            transform: scale(1.05);
        }
        /* Custom radio buttons for modal */
        .type-radio-label {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .type-radio:checked + .type-radio-label {
            color: white;
        }
        #type-expense:checked + .type-radio-label, #new-category-type-expense:checked + .type-radio-label {
            background-color: #ef4444; /* Red-500 */
            border-color: #ef4444;
        }
        #type-income:checked + .type-radio-label, #new-category-type-income:checked + .type-radio-label {
            background-color: #22c55e; /* Green-500 */
            border-color: #22c55e;
        }
        .modal {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .spinner {
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .icon-no-events {
            pointer-events: none;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900 text-center">My Wallet</h1>
            <p class="text-lg text-gray-600 mt-2 text-center">Your personal finance, simplified.</p>
        </header>
        
        <!-- Google Drive Sync Setup Notice -->
        <div id="api-setup-notice" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-md shadow-md" role="alert">
          <p class="font-bold">Developer Notice</p>
          <p>Google Drive sync is not configured. To enable this feature, you must create your own API Key and Client ID in the Google Cloud Console and add them to the script section of this file.</p>
        </div>


        <!-- Dashboard Summary -->
        <section id="dashboard" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm">
                <h2 class="text-gray-500 font-medium mb-2">Current Balance</h2>
                <p id="current-balance" class="text-3xl font-bold text-blue-600">₹0.00</p>
            </div>
            <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm">
                 <h2 class="text-gray-500 font-medium mb-2">Total Income</h2>
                <p id="total-income" class="text-3xl font-bold text-green-500">₹0.00</p>
            </div>
             <div class="dashboard-card bg-white p-6 rounded-xl shadow-sm">
                <h2 class="text-gray-500 font-medium mb-2">Total Expenses</h2>
                <p id="total-expenses" class="text-3xl font-bold text-red-500">₹0.00</p>
            </div>
        </section>
        
        <!-- Cloud Sync Section -->
        <section id="cloud-sync" class="bg-white p-4 rounded-xl shadow-sm mb-6 border border-gray-200">
            <h3 class="font-bold text-lg mb-2 text-center md:text-left">Cloud Sync</h3>
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div id="auth-container">
                    <button id="authorize_button" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 flex items-center">
                        <i class="fab fa-google mr-2"></i> Connect to Google Drive
                    </button>
                    <button id="signout_button" class="hidden bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">
                        Sign Out
                    </button>
                </div>
                <div id="sync-controls" class="hidden flex flex-col sm:flex-row gap-2">
                    <button id="upload_button" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300 flex items-center justify-center">
                        <i class="fas fa-cloud-upload-alt mr-2"></i> Upload
                    </button>
                    <button id="download_button" class="bg-yellow-500 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-yellow-600 transition duration-300 flex items-center justify-center">
                        <i class="fas fa-cloud-download-alt mr-2"></i> Download
                    </button>
                </div>
                <div id="sync-status" class="text-sm text-gray-600 text-center md:text-right w-full md:w-auto mt-2 md:mt-0">
                    Not connected.
                </div>
            </div>
        </section>


        <!-- Controls -->
        <div class="bg-white p-4 rounded-xl shadow-sm mb-6 border border-gray-200">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-center">
                 <div class="relative">
                    <i class="fas fa-search absolute top-1/2 left-3 transform -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="search-input" placeholder="Search transactions..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-center">
                     <button id="manage-categories-btn" class="w-full md:w-auto bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-purple-700 transition duration-300 flex items-center justify-center">
                        <i class="fas fa-tags mr-2"></i> Manage Categories
                    </button>
                </div>
                <div class="flex justify-end">
                    <button id="export-csv-btn" class="w-full md:w-auto bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-800 transition duration-300 flex items-center justify-center">
                        <i class="fas fa-file-csv mr-2"></i> Export to CSV
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Transaction Table -->
        <div class="bg-white rounded-xl shadow-lg overflow-hidden border border-gray-200">
             <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead class="bg-gray-100 border-b-2 border-gray-200">
                        <tr>
                            <th class="p-4 font-semibold text-gray-600">Date</th>
                            <th class="p-4 font-semibold text-gray-600">Details</th>
                            <th class="p-4 font-semibold text-gray-600 text-right">Amount</th>
                            <th class="p-4 font-semibold text-gray-600 text-center">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="expense-table-body"></tbody>
                </table>
             </div>
        </div>
        <p id="no-expenses-msg" class="text-center text-gray-500 mt-8 text-lg">No transactions yet. Tap the '+' button to add one!</p>
    </div>

    <!-- Add Transaction FAB -->
    <button id="add-expense-btn" class="fab bg-blue-600 text-white hover:bg-blue-700" title="Add Transaction">
        <i class="fas fa-plus text-2xl"></i>
    </button>

    <!-- Modals -->
    <!-- Modal for adding/editing transactions -->
    <div id="expense-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-8 w-full max-w-md transform scale-95 opacity-0" id="modal-content">
            <h2 id="modal-title" class="text-2xl font-bold mb-6">Add Transaction</h2>
            <form id="expense-form">
                <input type="hidden" id="expense-id">
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Type</label>
                    <div class="flex rounded-lg border border-gray-300 overflow-hidden">
                        <input type="radio" name="type" id="type-expense" value="expense" class="hidden type-radio" checked>
                        <label for="type-expense" class="type-radio-label w-1/2 text-center p-2 font-semibold text-gray-700">Expense</label>
                        <input type="radio" name="type" id="type-income" value="income" class="hidden type-radio">
                        <label for="type-income" class="type-radio-label w-1/2 text-center p-2 font-semibold text-gray-700">Income</label>
                    </div>
                </div>
                <div class="mb-4">
                    <label for="date" class="block text-gray-700 font-medium mb-1">Date</label>
                    <input type="date" id="date" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div class="mb-4">
                    <label for="category" class="block text-gray-700 font-medium mb-1">Category</label>
                    <select id="category" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="description" class="block text-gray-700 font-medium mb-1">Description</label>
                    <input type="text" id="description" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Weekly groceries" required>
                </div>
                <div class="mb-4">
                    <label for="amount" class="block text-gray-700 font-medium mb-1">Amount (₹)</label>
                    <input type="number" id="amount" min="0.01" step="0.01" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="0.00" required>
                </div>
                <div class="mb-6">
                    <label for="payment-method" class="block text-gray-700 font-medium mb-1">Account</label>
                    <select id="payment-method" class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="Cash">Cash</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Debit Card">Debit Card</option>
                        <option value="Bank Account">Bank Account</option>
                        <option value="UPI">UPI</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" class="cancel-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Cancel</button>
                    <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal for managing categories -->
    <div id="category-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="modal-content bg-white rounded-lg shadow-2xl p-8 w-full max-w-lg transform scale-95 opacity-0">
            <h2 class="text-2xl font-bold mb-6">Manage Categories</h2>
            
            <form id="add-category-form" class="mb-6 p-4 border rounded-lg bg-gray-50">
                 <h3 class="font-semibold text-lg mb-3">Add New Category</h3>
                 <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                    <div class="sm:col-span-2">
                        <label for="new-category-name" class="block text-gray-700 font-medium mb-1 text-sm">Category Name</label>
                        <input type="text" id="new-category-name" placeholder="e.g., Health Insurance" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div>
                         <button type="submit" class="w-full px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">Add</button>
                    </div>
                 </div>
                 <div class="mt-3">
                     <label class="block text-gray-700 font-medium mb-2 text-sm">Type</label>
                     <div class="flex rounded-lg border border-gray-300 overflow-hidden w-full sm:w-2/3">
                        <input type="radio" name="new-category-type" id="new-category-type-expense" value="expense" class="hidden type-radio" checked>
                        <label for="new-category-type-expense" class="type-radio-label w-1/2 text-center p-2 font-semibold text-gray-700 text-sm">Expense</label>
                        <input type="radio" name="new-category-type" id="new-category-type-income" value="income" class="hidden type-radio">
                        <label for="new-category-type-income" class="type-radio-label w-1/2 text-center p-2 font-semibold text-gray-700 text-sm">Income</label>
                    </div>
                 </div>
            </form>

            <div class="mt-6 border-t pt-6">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8">
                    <div>
                        <h3 class="font-semibold text-xl mb-3 text-red-600">Expenses</h3>
                        <div id="expense-categories-list" class="space-y-2 border rounded-lg p-3 h-48 overflow-y-auto bg-gray-50"></div>
                    </div>
                     <div>
                        <h3 class="font-semibold text-xl mb-3 text-green-600">Income</h3>
                        <div id="income-categories-list" class="space-y-2 border rounded-lg p-3 h-48 overflow-y-auto bg-gray-50"></div>
                    </div>
                </div>
            </div>

            <div class="flex justify-end mt-8">
                <button type="button" class="cancel-btn px-6 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition">Close</button>
            </div>
        </div>
    </div>


<script>
// --- Google Drive API Configuration ---
// IMPORTANT: To enable Google Drive sync, you must create your own API Key and Client ID from
// the Google Cloud Console (https://console.cloud.google.com/) and replace the placeholder values below.
// 1. Create a new project.
// 2. Enable the "Google Drive API".
// 3. Go to "Credentials", create an "API key".
// 4. Create an "OAuth 2.0 Client ID" for a "Web application".
//    - Add "http://localhost" and your website's URL to "Authorized JavaScript origins".
const API_KEY = 'AIzaSyDWlMa0bpzhhuHBx395CeFEezvee4dtGc4'; // <-- REPLACE WITH YOUR API KEY
const CLIENT_ID = '574659852575-9bt6045dect519qqi8aaig30ua9erff1.apps.googleusercontent.com'; // <-- REPLACE WITH YOUR CLIENT ID

const DISCOVERY_DOCS = ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"];
// This scope provides access to a special, hidden folder for this app only.
// It cannot see or access any other files in your Google Drive.
const SCOPES = 'https://www.googleapis.com/auth/drive.appdata';
const DATA_FILE_NAME = 'my_wallet_data.json';

let tokenClient;
let gapiInited = false;
let gisInited = false;

// --- Google API Initialization ---
// These functions are called by the Google API scripts, so they need to be in the global scope.
function gapiLoaded() {
    gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
    await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
    gapiInited = true;
    maybeEnableButtons();
}

function gisLoaded() {
    if (!CLIENT_ID || !API_KEY) {
        document.getElementById('api-setup-notice').classList.remove('hidden');
        document.getElementById('cloud-sync').classList.add('opacity-50', 'pointer-events-none');
        return;
    }
    tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID, scope: SCOPES,
        callback: (tokenResponse) => {
            if (tokenResponse && tokenResponse.access_token) {
                 document.getElementById('authorize_button').classList.add('hidden');
                 document.getElementById('signout_button').classList.remove('hidden');
                 document.getElementById('sync-controls').classList.remove('hidden');
                 document.getElementById('sync-status').textContent = 'Connected. Ready to sync.';
            }
        },
    });
    gisInited = true;
    maybeEnableButtons();
}

function maybeEnableButtons() {
    if (gapiInited && gisInited) {
        document.getElementById('authorize_button').classList.remove('opacity-50', 'pointer-events-none');
    }
}


// --- Main Application Logic ---
document.addEventListener('DOMContentLoaded', () => {
    // DOM Elements
    const syncStatusEl = document.getElementById('sync-status');
    const authorizeBtn = document.getElementById('authorize_button');
    const signoutBtn = document.getElementById('signout_button');
    const syncControls = document.getElementById('sync-controls');
    const uploadBtn = document.getElementById('upload_button');
    const downloadBtn = document.getElementById('download_button');

    // --- Google Drive Sync Functions ---
    const updateSigninStatus = (isSignedIn) => {
        if (isSignedIn) {
            authorizeBtn.classList.add('hidden');
            signoutBtn.classList.remove('hidden');
            syncControls.classList.remove('hidden');
            syncStatusEl.textContent = 'Connected to Google Drive.';
        } else {
            authorizeBtn.classList.remove('hidden');
            signoutBtn.classList.add('hidden');
            syncControls.classList.add('hidden');
            syncStatusEl.textContent = 'Not connected.';
        }
    };

    const getFileId = async () => {
        try {
            const response = await gapi.client.drive.files.list({
                spaces: 'appDataFolder',
                fields: 'files(id, name)',
                pageSize: 10
            });
            const files = response.result.files;
            const existingFile = files.find(file => file.name === DATA_FILE_NAME);
            return existingFile ? existingFile.id : null;
        } catch (err) {
            console.error("Error finding file:", err);
            syncStatusEl.textContent = 'Error: Could not find file.';
            return null;
        }
    };
    
    const uploadData = async () => {
        setSyncLoading(true, 'Uploading...');
        const fileId = await getFileId();
        const dataToSave = JSON.stringify({ expenses, categories });
        const blob = new Blob([dataToSave], { type: 'application/json' });
        
        const metadata = { name: DATA_FILE_NAME, mimeType: 'application/json' };
        
        const form = new FormData();
        form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
        form.append('file', blob);

        let path = '/upload/drive/v3/files';
        let method = 'POST';
        if (fileId) {
            path += `/${fileId}`;
            method = 'PATCH';
        }
        
        try {
            await gapi.client.request({ path, method, params: { uploadType: 'multipart' }, body: form });
            syncStatusEl.textContent = `Successfully uploaded at ${new Date().toLocaleTimeString()}`;
        } catch (err) {
            console.error("Upload failed:", err);
            syncStatusEl.textContent = 'Error: Upload failed.';
        } finally {
            setSyncLoading(false);
        }
    };

    const downloadData = async () => {
        if (!confirm('This will overwrite your local data with the data from Google Drive. Are you sure you want to proceed?')) {
            return;
        }
        setSyncLoading(true, 'Downloading...');
        const fileId = await getFileId();
        if (!fileId) {
            syncStatusEl.textContent = 'No data file found in your Drive.';
            setSyncLoading(false);
            return;
        }

        try {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });
            const data = JSON.parse(response.body);
            if (data.expenses && data.categories) {
                expenses = data.expenses;
                categories = data.categories;
                saveExpenses(); // This also calls renderExpenses
                saveCategories();
                syncStatusEl.textContent = `Data successfully restored from Drive.`;
            } else {
                 syncStatusEl.textContent = 'Error: Invalid data file in Drive.';
            }
        } catch (err) {
            console.error("Download failed:", err);
            syncStatusEl.textContent = 'Error: Download failed.';
        } finally {
            setSyncLoading(false);
        }
    };
    
    const setSyncLoading = (isLoading, message = '') => {
        if (isLoading) {
            uploadBtn.disabled = true;
            downloadBtn.disabled = true;
            uploadBtn.innerHTML = `<div class="spinner w-5 h-5 border-2 border-white rounded-full"></div>`;
            syncStatusEl.textContent = message;
        } else {
            uploadBtn.disabled = false;
            downloadBtn.disabled = false;
            uploadBtn.innerHTML = `<i class="fas fa-cloud-upload-alt mr-2"></i> Upload`;
        }
    };


    // Event listeners for sync buttons
    authorizeBtn.onclick = () => tokenClient.requestAccessToken({prompt: ''});
    signoutBtn.onclick = () => {
        if (gapi.client.getToken()) {
            google.accounts.oauth2.revoke(gapi.client.getToken().access_token, () => {
                gapi.client.setToken('');
                updateSigninStatus(false);
            });
        }
    };
    uploadBtn.onclick = uploadData;
    downloadBtn.onclick = downloadData;
    
    // --- Existing App Logic ---
    const addExpenseBtn = document.getElementById('add-expense-btn');
    const expenseModal = document.getElementById('expense-modal');
    const categoryModal = document.getElementById('category-modal');
    const expenseForm = document.getElementById('expense-form');
    const expenseTableBody = document.getElementById('expense-table-body');
    const searchInput = document.getElementById('search-input');
    const exportCsvBtn = document.getElementById('export-csv-btn');
    const manageCategoriesBtn = document.getElementById('manage-categories-btn');
    const addCategoryForm = document.getElementById('add-category-form');
    const expenseCategoriesList = document.getElementById('expense-categories-list');
    const incomeCategoriesList = document.getElementById('income-categories-list');
    
    let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
    let categories = [];

    const defaultCategories = [
        { id: 'cat-exp-1', name: 'Groceries', type: 'expense' }, { id: 'cat-exp-2', name: 'Shopping', type: 'expense' },
        { id: 'cat-exp-3', name: 'Housing', type: 'expense' }, { id: 'cat-exp-4', name: 'Transportation', type: 'expense' },
        { id: 'cat-exp-5', name: 'Vehicle', type: 'expense' }, { id: 'cat-exp-6', name: 'Entertainment', type: 'expense' },
        { id: 'cat-exp-7', name: 'Communication, PC', type: 'expense' }, { id: 'cat-exp-8', name: 'Financial expenses', type: 'expense' },
        { id: 'cat-exp-9', name: 'Other', type: 'expense' }, { id: 'cat-inc-1', name: 'Salary', type: 'income' },
        { id: 'cat-inc-2', name: 'Business', type: 'income' }, { id: 'cat-inc-3', name: 'Gifts', type: 'income' },
        { id: 'cat-inc-4', name: 'Extra income', type: 'income' }, { id: 'cat-inc-5', name: 'Loan', type: 'income' },
        { id: 'cat-inc-6', name: 'Other', type: 'income' },
    ];

    const initialize = () => {
        expenses.forEach(e => { if (!e.type) e.type = 'expense'; });
        const storedCategories = localStorage.getItem('categories');
        if (!storedCategories) {
            categories = defaultCategories;
            saveCategories();
        } else {
            categories = JSON.parse(storedCategories);
        }
        renderExpenses();
    };
    
    const openModal = (modal) => {
        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.style.opacity = '1';
            modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100');
        }, 10);
    };

    const closeModal = (modal) => {
        modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0');
        modal.style.opacity = '0';
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 300);
    };

    const saveExpenses = () => {
        localStorage.setItem('expenses', JSON.stringify(expenses));
        renderExpenses();
    };
    const saveCategories = () => {
        localStorage.setItem('categories', JSON.stringify(categories));
    };

    const renderExpenses = () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filteredExpenses = expenses.filter(expense => expense.description.toLowerCase().includes(searchTerm) || expense.category.toLowerCase().includes(searchTerm));
        expenseTableBody.innerHTML = '';
        const tableContainer = document.querySelector('.bg-white.rounded-xl.shadow-lg');
        const noExpensesMsg = document.getElementById('no-expenses-msg');

        if (filteredExpenses.length === 0) {
            noExpensesMsg.classList.remove('hidden');
            tableContainer.classList.add('hidden');
        } else {
            noExpensesMsg.classList.add('hidden');
            tableContainer.classList.remove('hidden');
        }
        
        filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

        filteredExpenses.forEach(expense => {
            const row = document.createElement('tr');
            const isIncome = expense.type === 'income';
            row.className = 'border-b border-gray-200 hover:bg-gray-50';
            const amountColor = isIncome ? 'text-green-600' : 'text-red-600';
            const amountPrefix = isIncome ? '+ ' : '- ';
            const icon = isIncome ? 'fa-arrow-up' : 'fa-arrow-down';
            row.innerHTML = `
                <td class="p-4">${new Date(expense.date).toLocaleDateString()}</td>
                <td class="p-4"><p class="font-semibold">${expense.description}</p><p class="text-sm text-gray-500">${expense.category}</p></td>
                <td class="p-4 text-right font-bold ${amountColor}"><i class="fas ${icon} mr-1 text-xs"></i>${amountPrefix}₹${parseFloat(expense.amount).toFixed(2)}</td>
                <td class="p-4 text-center">
                    <button class="text-gray-500 hover:text-blue-600 p-2 edit-btn" data-id="${expense.id}" title="Edit"><i class="fas fa-pencil-alt"></i></button>
                    <button class="text-gray-500 hover:text-red-600 p-2 delete-btn" data-id="${expense.id}" title="Delete"><i class="fas fa-trash-alt"></i></button>
                </td>
            `;
            expenseTableBody.appendChild(row);
        });
        updateDashboard();
    };

    const updateDashboard = () => {
        const totalIncome = expenses.filter(e => e.type === 'income').reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
        const totalExpenses = expenses.filter(e => e.type === 'expense').reduce((sum, exp) => sum + parseFloat(exp.amount), 0);
        const currentBalance = totalIncome - totalExpenses;
        document.getElementById('current-balance').textContent = `₹${currentBalance.toFixed(2)}`;
        document.getElementById('total-income').textContent = `₹${totalIncome.toFixed(2)}`;
        document.getElementById('total-expenses').textContent = `₹${totalExpenses.toFixed(2)}`;
    };

    const populateCategoryDropdown = (type) => {
        const categoryDropdown = document.getElementById('category');
        categoryDropdown.innerHTML = '';
        categories.filter(c => c.type === type).forEach(c => {
            const option = document.createElement('option');
            option.value = c.name; option.textContent = c.name;
            categoryDropdown.appendChild(option);
        });
    };

    const renderCategoryManagementList = () => {
        expenseCategoriesList.innerHTML = ''; incomeCategoriesList.innerHTML = '';
        categories.forEach(cat => {
            const catItem = document.createElement('div');
            catItem.className = 'flex items-center justify-between p-2 rounded-lg hover:bg-gray-100';
            catItem.innerHTML = `<input type="text" value="${cat.name}" data-id="${cat.id}" class="category-name-input bg-transparent flex-grow p-1 rounded focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none"><button data-id="${cat.id}" class="delete-category-btn text-gray-400 hover:text-red-600 ml-2 px-2"><i class="fas fa-trash-alt icon-no-events"></i></button>`;
            if (cat.type === 'expense') expenseCategoriesList.appendChild(catItem);
            else incomeCategoriesList.appendChild(catItem);
        });
    };

    addExpenseBtn.addEventListener('click', () => {
        document.getElementById('modal-title').textContent = 'Add Transaction';
        expenseForm.reset(); document.getElementById('expense-id').value = '';
        document.getElementById('date').valueAsDate = new Date();
        document.getElementById('type-expense').checked = true;
        populateCategoryDropdown('expense'); openModal(expenseModal);
    });

    expenseForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const expenseId = document.getElementById('expense-id').value;
        const transaction = {
            id: expenseId ? expenseId : Date.now().toString(),
            type: document.querySelector('input[name="type"]:checked').value, date: document.getElementById('date').value,
            category: document.getElementById('category').value, description: document.getElementById('description').value,
            amount: document.getElementById('amount').value, paymentMethod: document.getElementById('payment-method').value,
        };
        if (expenseId) expenses = expenses.map(exp => exp.id === expenseId ? transaction : exp);
        else expenses.push(transaction);
        saveExpenses(); closeModal(expenseModal);
    });

    expenseTableBody.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-btn');
        if (editBtn) {
            const expenseId = editBtn.dataset.id;
            const expenseToEdit = expenses.find(exp => exp.id === expenseId);
            document.getElementById('modal-title').textContent = 'Edit Transaction';
            document.getElementById('expense-id').value = expenseToEdit.id;
            document.getElementById(`type-${expenseToEdit.type}`).checked = true;
            document.getElementById('date').value = expenseToEdit.date;
            populateCategoryDropdown(expenseToEdit.type);
            document.getElementById('category').value = expenseToEdit.category;
            document.getElementById('description').value = expenseToEdit.description;
            document.getElementById('amount').value = expenseToEdit.amount;
            document.getElementById('payment-method').value = expenseToEdit.paymentMethod;
            openModal(expenseModal);
        }
        const deleteBtn = e.target.closest('.delete-btn');
        if (deleteBtn) {
            if (confirm('Are you sure you want to delete this transaction?')) {
                expenses = expenses.filter(exp => exp.id !== deleteBtn.dataset.id);
                saveExpenses();
            }
        }
    });
    
    document.querySelectorAll('input[name="type"]').forEach(radio => radio.addEventListener('change', (e) => populateCategoryDropdown(e.target.value)));
    searchInput.addEventListener('input', renderExpenses);
    document.querySelectorAll('.cancel-btn').forEach(btn => btn.addEventListener('click', () => { closeModal(expenseModal); closeModal(categoryModal); }));
    manageCategoriesBtn.addEventListener('click', () => { renderCategoryManagementList(); openModal(categoryModal); });
    addCategoryForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const nameInput = document.getElementById('new-category-name');
        const name = nameInput.value.trim();
        if (name) {
            const type = document.querySelector('input[name="new-category-type"]:checked').value;
            categories.push({ id: `cat-${Date.now()}`, name, type });
            saveCategories(); renderCategoryManagementList(); nameInput.value = ''; nameInput.focus();
        }
    });
    document.getElementById('category-modal').addEventListener('click', (e) => {
        if (e.target.closest('.delete-category-btn')) {
            const catId = e.target.closest('.delete-category-btn').dataset.id;
            if (confirm('Are you sure you want to delete this category?')) {
                categories = categories.filter(c => c.id !== catId);
                saveCategories(); renderCategoryManagementList();
            }
        }
    });
    document.getElementById('category-modal').addEventListener('change', (e) => {
        if (e.target.classList.contains('category-name-input')) {
            const catId = e.target.dataset.id; const newName = e.target.value.trim();
            const category = categories.find(c => c.id === catId);
            if (category && newName) {
                const oldName = category.name;
                expenses.forEach(exp => { if (exp.category === oldName && exp.type === category.type) exp.category = newName; });
                saveExpenses(); category.name = newName; saveCategories();
            } else { e.target.value = categories.find(c => c.id === catId).name; }
        }
    });
    exportCsvBtn.addEventListener('click', () => {
        if (expenses.length === 0) { alert('No transactions to export.'); return; }
        const headers = ['ID', 'Type', 'Date', 'Category', 'Description', 'Amount', 'Account'];
        const csvContent = [ headers.join(','), ...expenses.map(e => [e.id, e.type, e.date, `"${e.category.replace(/"/g, '""')}"`, `"${e.description.replace(/"/g, '""')}"`, e.amount, e.paymentMethod].join(',')) ].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a'); const url = URL.createObjectURL(blob);
        link.setAttribute('href', url); link.setAttribute('download', 'transactions.csv');
        link.style.visibility = 'hidden'; document.body.appendChild(link);
        link.click(); document.body.removeChild(link);
    });

    initialize();
});
</script>

</body>
</html>

